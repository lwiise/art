<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title><%= product.name %></title>
  <link rel="stylesheet" href="/auth-assets/styles.css" />
</head>
<body>
  <main class="container">
    <div class="topbar">
      <a class="auth-back" href="/products">&larr; Back to Products</a>
      <div class="actions">
        <% if (!currentUser) { %>
          <a class="btn-link" href="/signin?returnTo=<%= encodeURIComponent('/products/' + product.id) %>">Sign in</a>
          <a class="btn-link" href="/signup">Sign up</a>
        <% } else if (currentUser.role === "user") { %>
          <a class="btn-link" href="/dashboard">Dashboard</a>
          <button type="button" id="signoutBtn">Sign out</button>
        <% } else if (currentUser.role === "admin") { %>
          <a class="btn-link" href="/admin">Admin</a>
          <button type="button" id="signoutBtn">Sign out</button>
        <% } else { %>
          <a class="btn-link" href="/vendor">Vendor Dashboard</a>
          <button type="button" id="signoutBtn">Sign out</button>
        <% } %>
      </div>
    </div>
    <section class="card" style="margin-bottom:14px;">
      <div class="topbar">
        <div>
          <h1 style="margin:0;"><%= product.name %></h1>
          <div class="muted small"><%= (product.gallery_type || '').toUpperCase() %> - <%= product.category || "Uncategorized" %></div>
        </div>
        <div class="actions">
          <button type="button" id="favoriteBtn" class="favoriteBtn <%= likedByMe ? 'active' : '' %>" data-favorited="<%= likedByMe ? 'true' : 'false' %>">
            <span class="heart" aria-hidden="true"><% if (likedByMe) { %>&hearts;<% } else { %>&#9825;<% } %></span>
            <span id="favoriteCount"><%= likesCount || 0 %></span>
          </button>
          <button type="button" id="addCartBtn">Add to Cart</button>
        </div>
      </div>
      <% if (product.image_url) { %>
        <img src="<%= product.image_url %>" alt="<%= product.name %>" style="width:100%;max-height:520px;object-fit:contain;border:1px solid #e3e3e3;border-radius:14px;background:#fafafa;" />
      <% } %>
      <div class="grid two" style="margin-top:12px;">
        <div class="workspace-field-row">
          <span class="workspace-field-key">Artist</span>
          <span><%= product.artist_name || "Unknown" %></span>
        </div>
        <div class="workspace-field-row">
          <span class="workspace-field-key">Period</span>
          <span><%= product.period || "-" %></span>
        </div>
        <div class="workspace-field-row">
          <span class="workspace-field-key">Material</span>
          <span><%= product.material || "-" %></span>
        </div>
        <div class="workspace-field-row">
          <span class="workspace-field-key">Dimensions</span>
          <span><%= product.dimensions || "-" %></span>
        </div>
      </div>
    </section>

    <section class="card">
      <h2 style="margin:0 0 8px;">Comments</h2>
      <form id="commentForm">
        <div class="field-row">
          <textarea id="commentInput" rows="4" maxlength="1200" placeholder="Share your thoughts..."></textarea>
        </div>
        <div class="actions">
          <button class="primary" id="commentSubmitBtn" type="submit">Post Comment</button>
        </div>
        <div id="commentMsg" class="error"></div>
      </form>
      <hr class="auth-divider">
      <div id="commentsWrap" class="grid">
        <% if (!comments.length) { %>
          <div class="muted small">No comments yet.</div>
        <% } %>
        <% comments.forEach((comment) => { %>
          <article class="workspace-field-row">
            <div class="workspace-field-key"><%= comment.userName %></div>
            <div><%= comment.content %></div>
            <div class="muted small"><%= comment.createdAt %></div>
          </article>
        <% }) %>
      </div>
    </section>
  </main>

  <script src="/auth-assets/app.js"></script>
  <script>
    const productId = "<%= product.id %>";
    const currentUserRole = <%- JSON.stringify(currentUser ? currentUser.role : "") %>;
    const isUser = currentUserRole === "user";
    const isLoggedIn = Boolean(currentUserRole);
    const returnTo = `${window.location.pathname}${window.location.search}`;
    const signInUrl = `/signin?returnTo=${encodeURIComponent(returnTo)}`;
    if (window.APP && typeof APP.attachSignOutHandler === "function" && document.getElementById("signoutBtn")) {
      APP.attachSignOutHandler("signoutBtn", "/");
    }
    const sendApiRequest = (window.APP && typeof APP.apiRequest === "function")
      ? APP.apiRequest
      : async () => { throw new Error("Client assets failed to load."); };

    function escapeHtml(value) {
      return String(value || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }

    const commentsWrap = document.getElementById("commentsWrap");

    function renderComments(comments) {
      if (!Array.isArray(comments) || !comments.length) {
        commentsWrap.innerHTML = `<div class="muted small">No comments yet.</div>`;
        return;
      }
      commentsWrap.innerHTML = comments.map((comment) => `
        <article class="workspace-field-row">
          <div class="workspace-field-key">${escapeHtml(comment.userName)}</div>
          <div>${escapeHtml(comment.content)}</div>
          <div class="muted small">${escapeHtml(comment.createdAt)}</div>
        </article>
      `).join("");
    }

    async function refreshComments() {
      const result = await sendApiRequest(`/api/products/${encodeURIComponent(productId)}/comments`);
      renderComments(result.comments || []);
    }

    function requireUserForAction() {
      if (!isLoggedIn) {
        window.location.href = signInUrl;
        return false;
      }
      if (!isUser) {
        alert("This action is available only for user accounts.");
        return false;
      }
      return true;
    }

    const favoriteBtn = document.getElementById("favoriteBtn");
    const addCartBtn = document.getElementById("addCartBtn");
    const commentForm = document.getElementById("commentForm");
    const commentInput = document.getElementById("commentInput");
    const commentSubmitBtn = document.getElementById("commentSubmitBtn");
    const commentMsg = document.getElementById("commentMsg");

    function renderFavorite(favorited, count) {
      favoriteBtn.dataset.favorited = favorited ? "true" : "false";
      favoriteBtn.classList.toggle("active", !!favorited);
      const heart = favoriteBtn.querySelector(".heart");
      const countEl = document.getElementById("favoriteCount");
      if (heart) heart.textContent = favorited ? "\u2665" : "\u2661";
      if (countEl) countEl.textContent = String(Number(count || 0));
    }

    favoriteBtn?.addEventListener("click", async () => {
      if (!requireUserForAction()) return;
      favoriteBtn.disabled = true;
      try {
        const result = await sendApiRequest("/api/user/favorites/toggle", {
          method: "POST",
          body: JSON.stringify({ productId }),
        });
        renderFavorite(!!result.favorited, Number(result.likesCount || 0));
      } catch (error) {
        alert(error.message || "Could not update favorite.");
      } finally {
        favoriteBtn.disabled = false;
      }
    });

    addCartBtn?.addEventListener("click", async () => {
      if (!requireUserForAction()) return;
      addCartBtn.disabled = true;
      try {
        await sendApiRequest("/api/user/cart/add", {
          method: "POST",
          body: JSON.stringify({ productId, qty: 1 }),
        });
        addCartBtn.textContent = "Added";
      } catch (error) {
        alert(error.message || "Could not add to cart.");
      } finally {
        setTimeout(() => {
          addCartBtn.textContent = "Add to Cart";
          addCartBtn.disabled = false;
        }, 700);
      }
    });

    commentForm?.addEventListener("submit", async (event) => {
      event.preventDefault();
      if (!requireUserForAction()) return;
      commentMsg.textContent = "";
      commentSubmitBtn.disabled = true;
      try {
        await sendApiRequest(`/api/products/${encodeURIComponent(productId)}/comments`, {
          method: "POST",
          body: JSON.stringify({ content: commentInput.value }),
        });
        commentInput.value = "";
        commentMsg.className = "success";
        commentMsg.textContent = "Comment posted.";
        await refreshComments();
      } catch (error) {
        commentMsg.className = "error";
        commentMsg.textContent = error.message || "Could not post comment.";
      } finally {
        commentSubmitBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
