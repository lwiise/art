<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Products</title>
  <link rel="stylesheet" href="/auth-assets/styles.css" />
</head>
<body>
  <main class="container">
    <div class="topbar">
      <div>
        <h1 style="margin:0;">Products</h1>
        <p class="muted small" style="margin:6px 0 0;">Explore artworks, designs, books, and photography.</p>
      </div>
      <div class="actions" id="authNav">
        <% if (!currentUser) { %>
          <a class="btn-link" href="/signin?returnTo=%2F">Sign in</a>
          <a class="btn-link" href="/signup">Sign up</a>
        <% } else if (currentUser.role === "user") { %>
          <a class="btn-link" href="/dashboard">Dashboard</a>
          <button type="button" id="signoutBtnFallback">Sign out</button>
        <% } else if (currentUser.role === "vendor") { %>
          <a class="btn-link" href="/vendor">Vendor Dashboard</a>
          <button type="button" id="signoutBtnFallback">Sign out</button>
        <% } else { %>
          <a class="btn-link" href="/admin">Admin</a>
          <button type="button" id="signoutBtnFallback">Sign out</button>
        <% } %>
      </div>
    </div>

    <section class="card" style="margin-bottom:14px;">
      <form method="get" action="/" class="workspace-form-grid three">
        <div class="field-row">
          <label for="search">Search</label>
          <input id="search" name="search" value="<%= query.search || '' %>" placeholder="Name, artist, category..." />
        </div>
        <div class="field-row">
          <label for="galleryType">Category</label>
          <select id="galleryType" name="galleryType">
            <option value="">All</option>
            <option value="art" <%= (query.galleryType || query.gallery_type) === 'art' ? 'selected' : '' %>>Art</option>
            <option value="designs" <%= (query.galleryType || query.gallery_type) === 'designs' ? 'selected' : '' %>>Designs</option>
            <option value="books" <%= (query.galleryType || query.gallery_type) === 'books' ? 'selected' : '' %>>Books</option>
            <option value="photography" <%= (query.galleryType || query.gallery_type) === 'photography' ? 'selected' : '' %>>Photography</option>
            <option value="sculpture" <%= (query.galleryType || query.gallery_type) === 'sculpture' ? 'selected' : '' %>>Sculpture</option>
          </select>
        </div>
        <div class="field-row">
          <label for="pageSize">Page Size</label>
          <select id="pageSize" name="pageSize">
            <option value="12" <%= String(query.pageSize || '') === '12' ? 'selected' : '' %>>12</option>
            <option value="24" <%= !query.pageSize || String(query.pageSize) === '24' ? 'selected' : '' %>>24</option>
            <option value="48" <%= String(query.pageSize || '') === '48' ? 'selected' : '' %>>48</option>
          </select>
        </div>
        <div class="actions">
          <button class="primary" type="submit">Apply</button>
          <a class="btn-link" href="/">Reset</a>
        </div>
      </form>
    </section>

    <section class="grid three">
      <% if (!products.length) { %>
        <div class="card"><p class="muted small" style="margin:0;">No products found.</p></div>
      <% } %>
      <% products.forEach((product) => { %>
        <article class="card">
          <div class="workspace-item-name" style="margin-bottom:6px;"><%= product.name %></div>
          <div class="workspace-item-meta" style="margin-bottom:10px;"><%= (product.gallery_type || '').toUpperCase() %> - <%= (product.category || '').toUpperCase() %></div>
          <% if (product.image_url) { %>
            <img src="<%= product.image_url %>" alt="<%= product.name %>" style="width:100%;max-height:220px;object-fit:cover;border-radius:12px;border:1px solid #e5e5e5;margin-bottom:10px;" />
          <% } %>
          <div class="actions" style="margin-top:10px;">
            <a class="btn-link" href="/products/<%= encodeURIComponent(product.id) %>">Open</a>
            <button type="button" class="favoriteBtn <%= product.likedByMe ? 'active' : '' %>" data-product-id="<%= product.id %>" data-favorited="<%= product.likedByMe ? 'true' : 'false' %>">
              <span class="heart" aria-hidden="true"><%= product.likedByMe ? "♥" : "♡" %></span>
              <span class="favoriteCount"><%= product.likesCount || 0 %></span>
            </button>
            <button type="button" class="cartBtn" data-product-id="<%= product.id %>">Add to Cart</button>
          </div>
        </article>
      <% }); %>
    </section>

    <section class="card" style="margin-top:14px;">
      <div class="topbar">
        <div class="small muted">
          Showing page <%= paging.page %> / <%= paging.totalPages %> | Total products: <%= paging.total %>
        </div>
        <div class="actions">
          <% const queryBase = new URLSearchParams(query || {}); %>
          <% queryBase.set('pageSize', String(paging.pageSize)); %>
          <% if (paging.hasPrev) { queryBase.set('page', String(paging.page - 1)); %>
            <a class="btn-link" href="/?<%= queryBase.toString() %>">Prev</a>
          <% } %>
          <% if (paging.hasNext) { queryBase.set('page', String(paging.page + 1)); %>
            <a class="btn-link" href="/?<%= queryBase.toString() %>">Next</a>
          <% } %>
        </div>
      </div>
    </section>
  </main>

  <script src="/auth-assets/app.js"></script>
  <script>
    let currentUserRole = <%- JSON.stringify(currentUser ? currentUser.role : "") %>;
    const returnTo = `${window.location.pathname}${window.location.search}`;
    const signInUrl = `/signin?returnTo=${encodeURIComponent(returnTo)}`;
    const sendApiRequest = (window.APP && typeof APP.apiRequest === "function")
      ? APP.apiRequest
      : async () => { throw new Error("Client assets failed to load."); };
    if (window.APP && typeof APP.attachSignOutHandler === "function" && document.getElementById("signoutBtnFallback")) {
      APP.attachSignOutHandler("signoutBtnFallback", "/");
    }
    if (window.APP && typeof APP.mountAuthNav === "function") {
      APP.mountAuthNav("authNav", { returnTo, signoutRedirect: "/" })
        .then((user) => {
          currentUserRole = user && user.role ? user.role : currentUserRole;
        })
        .catch(() => {});
    }

    function requireUserForAction() {
      if (!currentUserRole) {
        window.location.href = signInUrl;
        return false;
      }
      if (currentUserRole !== "user") {
        alert("This action is available only for user accounts.");
        return false;
      }
      return true;
    }

    function renderFavoriteButton(button, favorited, count) {
      button.dataset.favorited = favorited ? "true" : "false";
      button.classList.toggle("active", !!favorited);
      const heart = button.querySelector(".heart");
      const favoriteCount = button.querySelector(".favoriteCount");
      if (heart) heart.textContent = favorited ? "♥" : "♡";
      if (favoriteCount) favoriteCount.textContent = String(Number(count || 0));
    }

    document.querySelectorAll(".favoriteBtn").forEach((button) => {
      button.addEventListener("click", async () => {
        if (!requireUserForAction()) return;
        const productId = button.getAttribute("data-product-id");
        if (!productId) return;
        button.disabled = true;
        try {
          const result = await sendApiRequest("/api/user/favorites/toggle", {
            method: "POST",
            body: JSON.stringify({ productId }),
          });
          renderFavoriteButton(button, !!result.favorited, Number(result.likesCount || 0));
        } catch (error) {
          alert(error.message || "Could not update favorite.");
        } finally {
          button.disabled = false;
        }
      });
    });

    document.querySelectorAll(".cartBtn").forEach((button) => {
      button.addEventListener("click", async () => {
        if (!requireUserForAction()) return;
        const productId = button.getAttribute("data-product-id");
        if (!productId) return;
        button.disabled = true;
        try {
          await sendApiRequest("/api/user/cart/add", {
            method: "POST",
            body: JSON.stringify({ productId, qty: 1 }),
          });
          button.textContent = "Added";
        } catch (error) {
          alert(error.message || "Could not add to cart.");
        } finally {
          setTimeout(() => {
            button.textContent = "Add to Cart";
            button.disabled = false;
          }, 700);
        }
      });
    });
  </script>
</body>
</html>
